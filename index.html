<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>My root</title>
    <link rel="stylesheet" href="style.css" />
    <script src="script.js"></script>
  </head>
  <style>
	html {
		width: 100%;
		height: 100%;
	}
  </style>
  <script type="module">
import kaboom from "https://unpkg.com/kaboom/dist/kaboom.mjs";

// Start game
kaboom({
	background: [ 135, 206, 235 ]
})

loadSprite("fox", "./sprites/Foxy.png", {
	sliceX: 56,
	// Define animations
	anims: {
		"idle": {
			from: 5,
			to: 18,
			speed: 7,
			loop: true,
		},
		"run": {
			from: 19,
			to: 26,
			speed: 10,
			loop: false,
		},
		"die": {
			from: 50,
			to: 55,
			speed: 10,
			loop: false,
		},
		"sleep": {
			from: 43,
			to: 47,
			speed: 3,
			loop: true,
		},
		"jump": {
			from: 30,
			to: 34,
			speed: 5,
			loop: false,
		},
	},
})

loadSprite("dirt", "./sprites/dirt.png")
loadSprite("fulldirt", "./sprites/fulldirt.png")
loadSprite("coblestone", "./sprites/coblestone.png")
loadSprite("stone", "./sprites/stone.png")
loadSprite("door", "./sprites/door.png")
loadSprite("lava", "./sprites/lava.png")
loadSprite("barriere", "./sprites/barriere.png")

const LEVELS = [
	[
	" c",
	" c",
	" c",
	" c",
	" c",
	" c",
	" c                ggg      ",
	" c                             g",
	" c                      gg ",
	" c                  gg",
	" c            gg    ",
	" cgggslllsggggddggggddggggggggggggg",
	" cddddsssddddddddddddddddddddddddddgggggggggggggggggggggg",
	" cdddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd",
	" csssssssssssssssssssssssssssssssssssssssssssssssssssss",
	],
]
const JUMP_FORCE = 800
const SPEED = 480
let JUMP_DIRECTION = false
let POWER = 1


scene("game", ({ levelIdx, score }) => {
const level = addLevel(LEVELS[levelIdx || 0], {
	// The size of each grid
	width: 64,
	height: 64,
	// The position of the top q dirt
	pos: vec2(-10, 1200),
	// Define what each symbol means (in components)
	"@": () => [
		sprite("fox"),
		area(),
		body(),
		scale(5),
		origin("bot"),
		"player",
	],
	"g": () => [
		sprite("dirt"),
		area(),
		solid(),
		origin("bot"),
	],
	"d": () => [
		sprite("fulldirt"),
		area(),
		solid(),
		origin("bot"),
	],
	"s": () => [
		sprite("stone"),
		area(),
		solid(),
		origin("bot"),
	],
	"c": () => [
		sprite("coblestone"),
		area(),
		solid(),
		origin("bot"),
	],
	"l": () => [
		sprite("lava"),
		area(),
		solid(),
		origin("bot"),
		"danger",
	],
})

gravity(1600)
const player = add([
		sprite("fox"),
		scale(4),
		area(),
		origin("center"),
		pos(150, 1100),
		body({ jumpForce: JUMP_FORCE, }),
		rotate(0),
	])

player.onGround(() => {
	if (!isKeyDown("q") && !isKeyDown("d")) {
		player.play("idle")
	} else {
		player.play("run")
	}
})

// Movements
onKeyPress("space", () => {
	if (POWER == 1) {
		player.doubleJump()
		player.flipX(JUMP_DIRECTION)
		player.play("jump")
	} else {
		if (player.isGrounded()) {
			player.jump()
			player.flipX(JUMP_DIRECTION)
			player.play("jump")
		}
	}
})

onKeyPress("s", () => {
	if (player.isGrounded()) {
		player.play("sleep")
	}
})

onKeyPress("r", () => {
	if (player.isGrounded()) {
		player.play("die")
		// player.pos = level.getPos(0, 0)
	}
})

onKeyDown("q", () => {
	player.move(-SPEED, 0)
	player.flipX(true)
	if (player.isGrounded() && player.curAnim() !== "run") {
		player.play("run")
		JUMP_DIRECTION = true
	}
})

onKeyDown("d", () => {
	player.move(SPEED, 0)
	player.flipX(false)
	if (player.isGrounded() && player.curAnim() !== "run") {
		player.play("run")
		JUMP_DIRECTION = false
	}
})

onKeyRelease(["q", "d"], () => {
	// Only reset to "idle" if player is not holding any of these keys
	if (player.isGrounded() && !isKeyDown("q") && !isKeyDown("d")) {
		player.play("idle")
	}
})

player.onUpdate(() => {
	// Set the viewport center to player.pos
	camPos(player.pos)
})

// Back to the original position if hit a "danger" item
player.onCollide("danger", () => {
	player.play("die")
	go("lose")
})

})


function addButton(txt, p, f) {

const btn = add([
	text(txt, {
		font: "sink",
		size: 48,
		width: width() - 24 * 2,
		lineSpacing: 8,
		letterSpacing: 4,
	}),
	pos(p),
	area({ cursor: "pointer", }),
	origin("center"),
])

btn.onClick(f)

btn.onUpdate(() => {
	if (btn.isHovering()) {
		const t = time() * 10
		btn.color = rgb(
			wave(0, 255, t),
			wave(0, 255, t + 2),
			wave(0, 255, t + 4),
		)
	} else {
		btn.scale = vec2(1)
		btn.color = rgb()
	}
})

}

scene("menu", () => {
add([
	text("The Root", {
		font: "sink",
		size: 48,
		width: width() - 24 * 2,
		lineSpacing: 8,
		letterSpacing: 4,
	}),
	origin("center"),
	pos(vec2((width() / 2), 200)),
])
addButton("Starting", vec2((width() / 2), (height() / 2)), () => go("game", {
	levelIdx: 0,
	score: 0,
}))
addButton("Quit", vec2((width() / 2), (height() / 2) + 100), () => debug.log("bah non mdr ?"))
onUpdate(() => cursor("default"))
})

scene("lose", () => {
	add([
	text("You'r died", {
		font: "sink",
		size: 48,
		width: width() - 24 * 2,
		lineSpacing: 8,
		letterSpacing: 4,
	}),
	origin("center"),
	pos(vec2((width() / 2), 200)),
])

// Press any key to go back
onKeyPress(restart)
})

scene("win", () => {

add([
	text("Win", {
		font: "sink",
		size: 48,
		width: width() - 24 * 2,
		lineSpacing: 8,
		letterSpacing: 4,
	}),
	origin("center"),
	pos(vec2((width() / 2), 200)),
])

onKeyPress(start)

})

function start() {
	go("menu")
}

function restart() {
	go("game", {
	levelIdx: 0,
	score: 0,
})
}

start()

</script>
<body>
</body>
</html>
